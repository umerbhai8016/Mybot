<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Universal AI Chat</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body {
      min-height: 100%;
    }
    pre {
      background: #111;
      color: #eee;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
    }
    .dark pre {
      background: #000;
    }
    #sidebar {
      transition: transform 0.3s ease;
    }
    .sidebar-hidden {
      transform: translateX(-100%);
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex">

<!-- Fallback Loader -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  Loading App...
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed md:static z-40 w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col min-h-screen">
  <div class="p-4 flex justify-between items-center border-b dark:border-gray-700">
    <button id="newChatBtn" class="bg-blue-500 text-white px-3 py-1 rounded">New Chat</button>
    <button id="closeSidebar" class="md:hidden text-xl">‚úï</button>
  </div>
  <div id="chatList" class="flex-1 overflow-y-auto"></div>
  <div class="p-3 border-t dark:border-gray-700 space-y-2">
    <button id="settingsBtn" class="w-full bg-gray-200 dark:bg-gray-700 p-2 rounded">Settings</button>
    <button id="darkToggle" class="w-full bg-gray-200 dark:bg-gray-700 p-2 rounded">Toggle Dark</button>
  </div>
</div>

<!-- Main Area -->
<div class="flex-1 flex flex-col min-h-screen">

  <!-- Top Bar -->
  <div class="p-3 border-b dark:border-gray-700 flex items-center gap-3">
    <button id="openSidebar" class="md:hidden text-2xl">‚ò∞</button>
    <h1 class="font-semibold">Universal AI Chat</h1>
  </div>

  <!-- Chat Messages -->
  <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

  <!-- Input Bar -->
  <div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 p-3">
    <div class="flex gap-2">
      <textarea id="userInput" rows="1"
        class="flex-1 resize-none p-2 border rounded dark:bg-gray-800"
        placeholder="Type your message..."></textarea>
      <button id="sendBtn"
        class="bg-blue-500 text-white px-4 rounded">Send</button>
    </div>
  </div>

</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded w-96 space-y-4">
    <h2 class="text-lg font-semibold">Settings</h2>
    <input id="apiKeyInput" type="password" placeholder="OpenRouter API Key"
      class="w-full p-2 border rounded dark:bg-gray-700">
    <input id="modelInput" type="text"
      value="deepseek/deepseek-r1:free"
      class="w-full p-2 border rounded dark:bg-gray-700">
    <textarea id="systemPromptInput" rows="3"
      placeholder="System Prompt..."
      class="w-full p-2 border rounded dark:bg-gray-700"></textarea>
    <div class="flex justify-end gap-2">
      <button id="saveSettings" class="bg-blue-500 text-white px-4 py-1 rounded">Save</button>
      <button id="closeSettings" class="bg-gray-400 px-4 py-1 rounded">Cancel</button>
    </div>
  </div>
</div>

<script>
(function(){

// Hide Loader
function initApp(){
  const loader = document.getElementById("loading");
  if(loader) loader.style.display = "none";
}
initApp();

// State
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let currentChatId = localStorage.getItem("currentChatId");
let apiKey = localStorage.getItem("apiKey") || "";
let model = localStorage.getItem("model") || "deepseek/deepseek-r1:free";
let darkMode = localStorage.getItem("darkMode") === "true";

if(darkMode) document.documentElement.classList.add("dark");

// DOM
const chatList = document.getElementById("chatList");
const messagesDiv = document.getElementById("messages");
const userInput = document.getElementById("userInput");

// Helpers
function saveState(){
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("currentChatId", currentChatId);
}

function createChat(){
  const id = Date.now().toString();
  const chat = {
    id,
    name: "New Chat",
    messages: [],
    systemPrompt: ""
  };
  chats.unshift(chat);
  currentChatId = id;
  saveState();
  renderChats();
  renderMessages();
}

function getCurrentChat(){
  return chats.find(c => c.id === currentChatId);
}

function renderChats(){
  chatList.innerHTML = "";
  chats.forEach(chat=>{
    const div = document.createElement("div");
    div.className = "p-3 border-b dark:border-gray-700 cursor-pointer flex justify-between items-center";
    div.innerHTML = `
      <span class="truncate">${chat.name}</span>
      <div class="flex gap-2">
        <button data-rename="${chat.id}">‚úèÔ∏è</button>
        <button data-delete="${chat.id}">üóëÔ∏è</button>
      </div>
    `;
    div.onclick = (e)=>{
      if(e.target.dataset.rename){
        const name = prompt("Rename chat:", chat.name);
        if(name){
          chat.name = name;
          saveState();
          renderChats();
        }
        return;
      }
      if(e.target.dataset.delete){
        if(confirm("Delete chat?")){
          chats = chats.filter(c=>c.id !== chat.id);
          if(currentChatId === chat.id){
            currentChatId = chats[0]?.id || null;
          }
          saveState();
          renderChats();
          renderMessages();
        }
        return;
      }
      currentChatId = chat.id;
      saveState();
      renderMessages();
    };
    chatList.appendChild(div);
  });
}

function renderMessages(){
  messagesDiv.innerHTML = "";
  const chat = getCurrentChat();
  if(!chat) return;
  chat.messages.forEach(msg=>{
    const div = document.createElement("div");
    div.className = msg.role === "user"
      ? "text-right"
      : "text-left";
    const bubble = document.createElement("div");
    bubble.className = msg.role === "user"
      ? "inline-block bg-blue-500 text-white p-3 rounded-lg max-w-[80%]"
      : "inline-block bg-gray-200 dark:bg-gray-700 p-3 rounded-lg max-w-[80%]";
    bubble.innerHTML = marked.parse(msg.content || "");
    div.appendChild(bubble);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Streaming
async function sendMessage(){
  if(!apiKey){
    alert("Set API key in settings.");
    return;
  }
  const chat = getCurrentChat();
  if(!chat) return;

  const content = userInput.value.trim();
  if(!content) return;
  userInput.value = "";

  chat.messages.push({role:"user", content});
  renderMessages();

  const aiMsg = {role:"assistant", content:""};
  chat.messages.push(aiMsg);
  renderMessages();

  try{
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer " + apiKey,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        model,
        stream:true,
        messages:[
          ...(chat.systemPrompt ? [{role:"system",content:chat.systemPrompt}] : []),
          ...chat.messages.filter(m=>m.role!=="assistant" || m.content)
        ]
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split("\n").filter(l=>l.startsWith("data:"));
      for(const line of lines){
        const json = line.replace("data:","").trim();
        if(json === "[DONE]") break;
        try{
          const data = JSON.parse(json);
          const token = data.choices?.[0]?.delta?.content;
          if(token){
            aiMsg.content += token;
            renderMessages();
          }
        }catch{}
      }
    }

    saveState();

  }catch(e){
    aiMsg.content = "Error: " + e.message;
    renderMessages();
  }
}

// Events
document.getElementById("newChatBtn").onclick = createChat;
document.getElementById("sendBtn").onclick = sendMessage;
userInput.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// Sidebar toggle
document.getElementById("openSidebar").onclick = ()=>{
  document.getElementById("sidebar").classList.remove("sidebar-hidden");
};
document.getElementById("closeSidebar").onclick = ()=>{
  document.getElementById("sidebar").classList.add("sidebar-hidden");
};
if(window.innerWidth < 768){
  document.getElementById("sidebar").classList.add("sidebar-hidden");
}

// Dark mode
document.getElementById("darkToggle").onclick = ()=>{
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("darkMode",
    document.documentElement.classList.contains("dark"));
};

// Settings
document.getElementById("settingsBtn").onclick = ()=>{
  document.getElementById("settingsModal").classList.remove("hidden");
  document.getElementById("apiKeyInput").value = apiKey;
  document.getElementById("modelInput").value = model;
  document.getElementById("systemPromptInput").value =
    getCurrentChat()?.systemPrompt || "";
};
document.getElementById("closeSettings").onclick = ()=>{
  document.getElementById("settingsModal").classList.add("hidden");
};
document.getElementById("saveSettings").onclick = ()=>{
  apiKey = document.getElementById("apiKeyInput").value.trim();
  model = document.getElementById("modelInput").value.trim();
  const sp = document.getElementById("systemPromptInput").value;
  const chat = getCurrentChat();
  if(chat) chat.systemPrompt = sp;
  localStorage.setItem("apiKey", apiKey);
  localStorage.setItem("model", model);
  saveState();
  document.getElementById("settingsModal").classList.add("hidden");
};

// Init
if(!currentChatId) createChat();
renderChats();
renderMessages();

})();
</script>

</body>
</html>
