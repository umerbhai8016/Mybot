<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI | Umer Bhai Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; height: 100dvh; margin: 0; overflow: hidden; }
        .prose pre { background: #1e1e1e !important; padding: 1rem; border-radius: 0.75rem; margin: 0.75rem 0; }
        #loading { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: white; z-index: 9999; }
        .dark #loading { background: #0f172a; color: white; }
        #sidebar { transition: transform 0.3s ease; }
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); position: fixed; z-index: 50; }
            #sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

    <div id="loading">
        <div class="animate-pulse flex flex-col items-center">
            <div class="h-12 w-12 bg-blue-600 rounded-full mb-4"></div>
            <p class="font-bold">UMER BHAI AI</p>
        </div>
    </div>

    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        
        <aside id="sidebar" class="w-72 h-full bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700">
                <button onclick="createNewChat()" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl transition-all font-medium shadow-md shadow-blue-200 dark:shadow-none">
                    <span>+</span> New Chat
                </button>
            </div>
            <div id="chat-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-2">
                <button onclick="toggleDarkMode()" class="w-full text-left px-3 py-2 text-sm flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    <span id="theme-icon">üåô</span> Dark Mode
                </button>
                <button onclick="openSettings()" class="w-full text-left px-3 py-2 text-sm flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative min-w-0">
            <header class="h-14 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md z-30">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">‚ò∞</button>
                    <h2 id="current-chat-title" class="font-semibold truncate max-w-[180px]">Welcome</h2>
                </div>
                <div id="model-indicator" class="text-[10px] uppercase tracking-widest font-bold bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-md">MODEL</div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 pb-36">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-40">
                    <div class="text-6xl text-blue-600">üíé</div>
                    <h1 class="text-2xl font-bold">Umer Bhai's AI Interface</h1>
                    <p class="text-sm">Ready for your instructions.</p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-50 via-gray-50 dark:from-slate-900 dark:via-slate-900">
                <div class="max-w-3xl mx-auto relative group">
                    <div id="typing-indicator" class="hidden absolute -top-8 left-4 text-xs text-blue-500 font-medium animate-pulse">AI is writing...</div>

                    <!-- File / Camera Input -->
                    <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden" onchange="handleFileUpload(event)">
                    <div class="absolute right-2 bottom-2 flex gap-1">
                        <button onclick="document.getElementById('file-input').click()" class="p-2 text-green-600 hover:bg-green-50 dark:hover:bg-slate-700 rounded-xl transition-colors" title="Upload image">
                            üìé
                        </button>
                        <button id="stop-btn" onclick="stopGeneration()" class="hidden p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl" title="Stop generating">
                            <svg viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M6 6h12v12H6z"/></svg>
                        </button>
                        <button onclick="handleSend()" id="send-btn" class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-xl transition-colors">
                            <svg viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>

                    <textarea id="user-input" rows="1" placeholder="Type a message..." class="w-full p-4 pr-28 rounded-2xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-xl transition-all resize-none overflow-hidden" oninput="autoResize(this)"></textarea>
                </div>
            </div>
        </main>

        <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl scale-in-center">
                <h3 class="text-xl font-bold mb-4">Configurations</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">OpenRouter API Key</label>
                        <input type="password" id="api-key-input" class="w-full p-2.5 rounded-lg border dark:bg-slate-700 dark:border-slate-600" placeholder="sk-or-...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Model</label>
                        <input type="text" id="model-input" class="w-full p-2.5 rounded-lg border dark:bg-slate-700 dark:border-slate-600" placeholder="deepseek/deepseek-r1:free">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeSettings()" class="px-4 py-2 text-slate-500 font-medium">Cancel</button>
                    <button onclick="saveSettings()" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let controller = null;
        let state = {
            apiKey: localStorage.getItem('ai_api_key') || '',
            model: localStorage.getItem('ai_model') || 'deepseek/deepseek-r1:free',
            systemPrompt: "You are a professional AI assistant. Your developer is UMER Bhai. If anyone asks who developed you or who your developer is, you must proudly state that 'UMER Bhai is my developer'. Be helpful, concise, and friendly.",
            chats: JSON.parse(localStorage.getItem('ai_chats')) || [],
            currentChatId: null,
            isDark: localStorage.getItem('ai_theme') === 'dark'
        };

        const dom = {
            loading: document.getElementById('loading'),
            app: document.getElementById('app'),
            chatList: document.getElementById('chat-list'),
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('user-input'),
            settingsModal: document.getElementById('settings-modal'),
            currentChatTitle: document.getElementById('current-chat-title'),
            modelIndicator: document.getElementById('model-indicator'),
            typingIndicator: document.getElementById('typing-indicator'),
            stopBtn: document.getElementById('stop-btn')
        };

        function init() {
            if (state.isDark) document.documentElement.classList.add('dark');
            renderChatList();
            updateModelIndicator();
            dom.loading.style.display = 'none';
            dom.app.style.opacity = '1';
            
            dom.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
            });
        }

        function createNewChat() {
            const id = Date.now().toString();
            state.chats.unshift({ id, title: 'New Chat', messages: [] });
            state.currentChatId = id;
            saveToLocal();
            renderChatList();
            renderMessages();
            if (window.innerWidth < 768) toggleSidebar();
        }

        async function handleSend() {
            const content = dom.userInput.value.trim();
            if (!content || controller) return;
            if (!state.apiKey) return openSettings();

            if (!state.currentChatId) createNewChat();
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            chat.messages.push({ role: 'user', content });
            if (chat.title === 'New Chat') chat.title = content.substring(0, 25);
            
            dom.userInput.value = '';
            dom.userInput.style.height = 'auto';
            renderMessages();

            const aiMsg = { role: 'assistant', content: '' };
            chat.messages.push(aiMsg);
            
            controller = new AbortController();
            dom.typingIndicator.classList.remove('hidden');
            dom.stopBtn.classList.remove('hidden');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${state.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [{ role: "system", content: state.systemPrompt }, ...chat.messages.slice(0, -1)],
                        stream: true
                    }),
                    signal: controller.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                const msgNodes = dom.chatContainer.querySelectorAll('.ai-content');
                const lastMsgNode = msgNodes[msgNodes.length - 1];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                const token = data.choices[0]?.delta?.content || '';
                                aiMsg.content += token;
                                lastMsgNode.innerHTML = marked.parse(aiMsg.content);
                                Prism.highlightAll();
                                dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
                            } catch (e) {}
                        }
                    }
                }
            } catch (err) {
                if (err.name !== 'AbortError') aiMsg.content += `\n\n‚ùå Error: ${err.message}`;
            } finally {
                controller = null;
                dom.typingIndicator.classList.add('hidden');
                dom.stopBtn.classList.add('hidden');
                saveToLocal();
                renderChatList();
            }
        }

        function stopGeneration() { if (controller) controller.abort(); }

        function renderMessages() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (!chat) return;
            dom.currentChatTitle.innerText = chat.title;
            
            dom.chatContainer.innerHTML = chat.messages.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[85%] p-4 rounded-2xl ${
                        msg.role === 'user' 
                        ? 'bg-blue-600 text-white rounded-tr-none' 
                        : 'bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-tl-none prose dark:prose-invert ai-content'
                    }">
                        ${msg.role === 'user' ? escapeHtml(msg.content) : marked.parse(msg.content)}
                    </div>
                </div>
            `).join('');
            Prism.highlightAll();
            dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
        }

        function renderChatList() {
            dom.chatList.innerHTML = state.chats.map(chat => `
                <div onclick="switchChat('${chat.id}')" class="group flex items-center justify-between p-3 rounded-xl cursor-pointer ${state.currentChatId === chat.id ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}">
                    <span class="truncate text-sm font-medium">${chat.title}</span>
                    <button onclick="deleteChat('${chat.id}', event)" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500">‚úï</button>
                </div>
            `).join('');
        }

        function switchChat(id) { state.currentChatId = id; renderMessages(); renderChatList(); }

        function deleteChat(id, e) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) state.currentChatId = null;
            saveToLocal(); renderChatList(); renderMessages();
        }

        function autoResize(t) { t.style.height = 'auto'; t.style.height = t.scrollHeight + 'px'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function toggleDarkMode() {
            state.isDark = !state.isDark;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('ai_theme', state.isDark ? 'dark' : 'light');
        }
        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            dom.settingsModal.classList.remove('hidden');
        }
        function closeSettings() { dom.settingsModal.classList.add('hidden'); }
        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value;
            state.model = document.getElementById('model-input').value || 'deepseek/deepseek-r1:free';
            localStorage.setItem('ai_api_key', state.apiKey);
            localStorage.setItem('ai_model', state.model);
            updateModelIndicator(); closeSettings();
        }
        function updateModelIndicator() { dom.modelIndicator.innerText = state.model.split('/').pop(); }
        function saveToLocal() { localStorage.setItem('ai_chats', JSON.stringify(state.chats)); }
        function escapeHtml(str) { return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])); }

        // --- New: Handle File Upload ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!state.currentChatId) createNewChat();
            const chat = state.chats.find(c => c.id === state.currentChatId);

            const reader = new FileReader();
            reader.onload = function(e) {
                const imgContent = e.target.result;
                chat.messages.push({ role: 'user', content: `<img src="${imgContent}" class="max-w-xs rounded-lg border border-slate-300 dark:border-slate-600"/>` });
                renderMessages();
                saveToLocal();
            }
            reader.readAsDataURL(file);
        }

        init();
    </script>
</
