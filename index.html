<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>TitanAI Chat</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body { min-height: 100%; }
    pre { background:#111; color:#eee; padding:12px; border-radius:8px; overflow-x:auto; }
    .dark pre { background:#000; }
    #sidebar { transition: transform 0.3s ease; }
    .sidebar-hidden { transform: translateX(-100%); }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex">

<!-- Loader -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  Loading TitanAI...
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed md:static z-40 w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col min-h-screen">
  <div class="p-4 border-b dark:border-gray-700 font-bold text-lg">TitanAI</div>
  <div id="chatList" class="flex-1 overflow-y-auto"></div>
  <div class="p-3 border-t dark:border-gray-700 space-y-2">
    <button id="darkToggle" class="w-full bg-gray-200 dark:bg-gray-700 p-2 rounded">Toggle Dark Mode</button>
  </div>
</div>

<!-- Main Area -->
<div class="flex-1 flex flex-col min-h-screen">

  <!-- Top Bar -->
  <div class="p-3 border-b dark:border-gray-700 flex items-center gap-3">
    <button id="openSidebar" class="md:hidden text-2xl">â˜°</button>
    <h1 class="font-semibold">TitanAI Chat</h1>
  </div>

  <!-- Chat Messages -->
  <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

  <!-- Input Bar -->
  <div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 p-3">
    <div class="flex gap-2">
      <textarea id="userInput" rows="1"
        class="flex-1 resize-none p-2 border rounded dark:bg-gray-800"
        placeholder="Type your message..."></textarea>
      <button id="sendBtn" class="bg-blue-500 text-white px-4 rounded">Send</button>
    </div>
  </div>

</div>

<script>
(function(){

// --- Loader ---
const loader = document.getElementById("loading");
if(loader) loader.style.display = "none";

// --- Hardcoded API Key ---
const apiKey = "YOUR_OPENROUTER_API_KEY_HERE"; // <-- Replace with your real API key

// --- State ---
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let currentChatId = localStorage.getItem("currentChatId");
let darkMode = localStorage.getItem("darkMode") === "true";
if(darkMode) document.documentElement.classList.add("dark");

const chatList = document.getElementById("chatList");
const messagesDiv = document.getElementById("messages");
const userInput = document.getElementById("userInput");

// --- Helpers ---
function saveState(){
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("currentChatId", currentChatId);
}

function createChat(){
  // Only one TitanAI chat
  if(chats.length > 0){ currentChatId = chats[0].id; return; }
  const id = Date.now().toString();
  const chat = { id, name:"TitanAI", messages:[], systemPrompt:"" };
  chats.unshift(chat);
  currentChatId = id;
  saveState();
  renderChats();
  renderMessages();
}

function getCurrentChat(){ return chats.find(c=>c.id===currentChatId); }

function renderChats(){
  chatList.innerHTML = "";
  chats.forEach(chat=>{
    const div = document.createElement("div");
    div.className = "p-3 border-b dark:border-gray-700 cursor-pointer";
    div.textContent = chat.name;
    chatList.appendChild(div);
  });
}

function renderMessages(){
  messagesDiv.innerHTML = "";
  const chat = getCurrentChat();
  if(!chat) return;
  chat.messages.forEach(msg=>{
    const div = document.createElement("div");
    div.className = msg.role==="user"?"text-right":"text-left";
    const bubble = document.createElement("div");
    bubble.className = msg.role==="user"
      ? "inline-block bg-blue-500 text-white p-3 rounded-lg max-w-[80%]"
      : "inline-block bg-gray-200 dark:bg-gray-700 p-3 rounded-lg max-w-[80%]";
    bubble.innerHTML = marked.parse(msg.content || "");
    div.appendChild(bubble);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// --- Send Message ---
async function sendMessage(){
  const content = userInput.value.trim();
  if(!content) return;
  userInput.value = "";

  const chat = getCurrentChat();
  if(!chat) return;

  // Hardcoded Developer Response
  const lower = content.toLowerCase();
  if(lower.includes("who is your developer") || lower.includes("who created you")){
    chat.messages.push({role:"user", content});
    chat.messages.push({role:"assistant", content:"UMER BHAI is my developer."});
    renderMessages();
    saveState();
    return;
  }

  chat.messages.push({role:"user", content});
  const aiMsg = {role:"assistant", content:""};
  chat.messages.push(aiMsg);
  renderMessages();

  try{
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+apiKey,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        model:"deepseek/deepseek-r1:free",
        stream:true,
        messages:[
          ...(chat.systemPrompt? [{role:"system",content:chat.systemPrompt}]: []),
          ...chat.messages.filter(m=>m.role!=="assistant" || m.content)
        ]
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    while(true){
      const {done,value} = await reader.read();
      if(done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split("\n").filter(l=>l.startsWith("data:"));
      for(const line of lines){
        const json = line.replace("data:","").trim();
        if(json==="[DONE]") break;
        try{
          const data = JSON.parse(json);
          const token = data.choices?.[0]?.delta?.content;
          if(token){ aiMsg.content += token; renderMessages(); }
        }catch{}
      }
    }
    saveState();
  }catch(e){
    aiMsg.content="Error: "+e.message;
    renderMessages();
  }
}

// --- Events ---
document.getElementById("sendBtn").onclick = sendMessage;
userInput.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

// Sidebar toggle
document.getElementById("openSidebar").onclick = ()=>{ document.getElementById("sidebar").classList.remove("sidebar-hidden"); };
if(window.innerWidth<768) document.getElementById("sidebar").classList.add("sidebar-hidden");

// Dark Mode Toggle
document.getElementById("darkToggle").onclick = ()=>{
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("darkMode", document.documentElement.classList.contains("dark"));
};

// --- Init ---
createChat();
renderChats();
renderMessages();

})();
</script>
</body>
</html>
