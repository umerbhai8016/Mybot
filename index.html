<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --vh: 1vh;
        }

        body {
            font-family: 'Inter', sans-serif;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
        }

        /* Markdown Styling */
        .prose pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .prose code { font-family: monospace; font-size: 0.9em; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .dark #loading { background: #0f172a; color: white; }

        /* Mobile Sidebar Overlay */
        #sidebar-overlay {
            display: none;
        }
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                z-index: 50;
                transition: left 0.3s ease;
            }
            #sidebar.open { left: 0; }
            #sidebar-overlay.open { display: block; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

    <div id="loading">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="font-medium">Initializing AI Interface...</p>
        </div>
    </div>

    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="w-72 h-full bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <button onclick="createNewChat()" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 px-4 py-2 rounded-full transition-all w-full text-sm font-medium">
                    <span>+</span> New Chat
                </button>
            </div>
            
            <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-2">
                <button onclick="toggleDarkMode()" class="w-full text-left px-3 py-2 text-sm flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">
                    <span id="theme-icon">üåô</span> Dark Mode
                </button>
                <button onclick="openSettings()" class="w-full text-left px-3 py-2 text-sm flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative min-w-0">
            <header class="h-14 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-30">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                        ‚ò∞
                    </button>
                    <h2 id="current-chat-title" class="font-semibold truncate max-w-[200px]">New Chat</h2>
                </div>
                <div id="model-indicator" class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1 rounded">
                    deepseek-r1
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 pb-32">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-50">
                    <div class="text-5xl">‚ú®</div>
                    <h1 class="text-2xl font-bold">How can I help you today?</h1>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent dark:from-slate-900 dark:via-slate-900">
                <div class="max-w-3xl mx-auto relative">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message AI..." 
                        class="w-full p-4 pr-12 rounded-2xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none shadow-lg"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button 
                        onclick="handleSend()" 
                        id="send-btn"
                        class="absolute right-3 bottom-3 p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-xl transition-colors"
                    >
                        <svg viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                    </button>
                </div>
            </div>
        </main>

        <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
                        <input type="password" id="api-key-input" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" placeholder="sk-or-...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Model Name</label>
                        <input type="text" id="model-input" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" placeholder="deepseek/deepseek-r1:free">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">System Prompt</label>
                        <textarea id="system-prompt-input" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" rows="3"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeSettings()" class="px-4 py-2 text-slate-500">Cancel</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = {
            apiKey: localStorage.getItem('ai_api_key') || '',
            model: localStorage.getItem('ai_model') || 'deepseek/deepseek-r1:free',
            systemPrompt: localStorage.getItem('ai_system_prompt') || 'You are a helpful AI assistant.',
            chats: JSON.parse(localStorage.getItem('ai_chats')) || [],
            currentChatId: null,
            isDark: localStorage.getItem('ai_theme') === 'dark',
            isStreaming: false
        };

        // --- DOM Elements ---
        const dom = {
            loading: document.getElementById('loading'),
            app: document.getElementById('app'),
            chatList: document.getElementById('chat-list'),
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('user-input'),
            settingsModal: document.getElementById('settings-modal'),
            currentChatTitle: document.getElementById('current-chat-title'),
            modelIndicator: document.getElementById('model-indicator')
        };

        // --- Core Logic ---
        function init() {
            if (state.isDark) document.documentElement.classList.add('dark');
            renderChatList();
            updateModelIndicator();
            
            // Show app
            dom.loading.style.opacity = '0';
            setTimeout(() => {
                dom.loading.style.display = 'none';
                dom.app.style.opacity = '1';
            }, 300);

            // Handle Enter Key
            dom.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
        }

        function updateModelIndicator() {
            dom.modelIndicator.innerText = state.model.split('/').pop();
        }

        // --- Chat Management ---
        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: [],
                timestamp: new Date().toISOString()
            };
            state.chats.unshift(newChat);
            switchChat(newChat.id);
            saveToLocal();
            renderChatList();
            if (window.innerWidth < 768) toggleSidebar();
        }

        function switchChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            dom.currentChatTitle.innerText = chat ? chat.title : 'New Chat';
            renderMessages();
            renderChatList();
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) {
                state.currentChatId = null;
                dom.chatContainer.innerHTML = '';
            }
            saveToLocal();
            renderChatList();
        }

        // --- UI Rendering ---
        function renderChatList() {
            dom.chatList.innerHTML = state.chats.map(chat => `
                <div onclick="switchChat('${chat.id}')" class="group flex items-center justify-between p-3 rounded-lg cursor-pointer ${state.currentChatId === chat.id ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}">
                    <span class="truncate text-sm w-full">${chat.title}</span>
                    <button onclick="deleteChat('${chat.id}', event)" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500">‚úï</button>
                </div>
            `).join('');
        }

        function renderMessages() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (!chat || chat.messages.length === 0) {
                dom.chatContainer.innerHTML = `
                    <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-50">
                        <div class="text-5xl">‚ú®</div>
                        <h1 class="text-2xl font-bold">How can I help?</h1>
                    </div>
                `;
                return;
            }

            dom.chatContainer.innerHTML = chat.messages.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2">
                    <div class="max-w-[85%] md:max-w-[70%] p-4 rounded-2xl ${
                        msg.role === 'user' 
                        ? 'bg-blue-600 text-white rounded-tr-none' 
                        : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-tl-none prose dark:prose-invert'
                    }">
                        ${msg.role === 'user' ? escapeHtml(msg.content) : marked.parse(msg.content)}
                    </div>
                </div>
            `).join('');
            
            dom.chatContainer.scrollTo({ top: dom.chatContainer.scrollHeight, behavior: 'smooth' });
        }

        // --- API Integration ---
        async function handleSend() {
            const content = dom.userInput.value.trim();
            if (!content || state.isStreaming) return;

            if (!state.apiKey) {
                alert('Please set your OpenRouter API Key in Settings.');
                return openSettings();
            }

            // 1. Initialize chat if none exists
            if (!state.currentChatId) {
                createNewChat();
            }

            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            // 2. Add User Message
            chat.messages.push({ role: 'user', content });
            if (chat.title === 'New Chat') chat.title = content.substring(0, 30) + '...';
            
            dom.userInput.value = '';
            dom.userInput.style.height = 'auto';
            renderMessages();

            // 3. Prepare AI Message Placeholder
            const aiMsg = { role: 'assistant', content: '' };
            chat.messages.push(aiMsg);
            renderMessages();
            const messageNodes = dom.chatContainer.querySelectorAll('.prose');
            const targetDiv = messageNodes[messageNodes.length - 1];

            state.isStreaming = true;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [
                            { role: "system", content: state.systemPrompt },
                            ...chat.messages.slice(0, -1) // All except the placeholder
                        ],
                        stream: true
                    })
                });

                if (!response.ok) throw new Error(await response.text());

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                const token = data.choices[0]?.delta?.content || '';
                                aiMsg.content += token;
                                targetDiv.innerHTML = marked.parse(aiMsg.content);
                                dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
                            } catch (e) {}
                        }
                    }
                }
            } catch (err) {
                aiMsg.content = `‚ùå Error: ${err.message}`;
                renderMessages();
            } finally {
                state.isStreaming = false;
                saveToLocal();
                renderChatList();
            }
        }

        // --- Utilities ---
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function toggleDarkMode() {
            state.isDark = !state.isDark;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('ai_theme', state.isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').innerText = state.isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            dom.settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            dom.settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value.trim();
            state.model = document.getElementById('model-input').value.trim() || 'deepseek/deepseek-r1:free';
            state.systemPrompt = document.getElementById('system-prompt-input').value.trim();
            
            localStorage.setItem('ai_api_key', state.apiKey);
            localStorage.setItem('ai_model', state.model);
            localStorage.setItem('ai_system_prompt', state.systemPrompt);
            
            updateModelIndicator();
            closeSettings();
        }

        function saveToLocal() {
            localStorage.setItem('ai_chats', JSON.stringify(state.chats));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Start App ---
        window.addEventListener('load', init);

    </script>
</body>
  </html>
